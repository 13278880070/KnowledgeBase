##  Redis如何过期密钥

Redis密钥以两种方式过期： 惰性删除和定期删除方式。

当某个客户端尝试访问密钥时，如果发现该key 已经过期，则该key 将被被动删除。

当然这还不够，因为有一些已经过期的密钥永远不会被再次访问。这些密钥无论如何都应该过期，所以Redis会周期性地在具有过期集的密钥中随机测试几个密钥。已经过期的所有密钥都将从密钥空间中删除。

具体来说，这就是Redis每秒做10次的事情：

1. 从具有相关过期的密钥集中测试20个随机密钥。
2. 删除找到的所有密钥已过期。
3. 如果超过25％的密钥已过期，请从步骤1重新开始。

这是一个简单的概率算法，基本上假设我们的样本代表整个密钥空间，我们继续到期，直到可能过期的密钥百分比低于25％

这意味着在任何给定时刻，使用内存的已经过期的最大键数量最大等于每秒最大写入操作量除以4。

### 过期键对内存的影响：

**rdb**：在创建新的RDB 文件的时候，程序会对键进行检查，过期键不会被写入到更新后的RDB文件中。因此，过期键对更新后的RDB 文件没有影响。

**aof**:在键已经过期，但是还没有被惰性删除之前，这个键不会产生任何影响，AOF 文件也不会因为这个键而修改，当过期键被惰性删除或者定期删除之后，程序会向AOF 文件追加一条命令，来显示地记录该键已经被删除。

例如：如果客户端使用 GET message 试图访问 message 键的值，但是 message 已经过期了，那么服务器执行以下三个动作：

1. 从数据库中删除 message 
2. 追加一条 DEL message 命令到 aof 文件
3. 向客户端返回 nil

**aof重写**：和 RDB 文件类似，当进行AOF重写时，程序会对键进行检查，过期的键不会被保存到重写后的AOF 问价。因此过期键对重写后的AOF 文件没有影响。



### 如何在 replication link 和AOF文件中处理过期

为了在不牺牲一致性的情况下保证正确性，当密钥到期时，在AOF文件中合成[DEL](https://redis.io/commands/del)操作并获得所有附加的副本节点。这样，到期过程集中在主实例中，并且不存在一致性错误。

但是，虽然连接到主服务器的副本不会独立的将 key 过期（但会等待来自主服务器的[DEL](https://redis.io/commands/del)），但它们仍将采用数据集中存在的过期的完整状态，因此当副本被选为主服务器时它将能够独立地使密钥到期，充分充当主人。

